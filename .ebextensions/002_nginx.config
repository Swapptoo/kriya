files:
    "/etc/nginx/conf.d/webapp_healthd.conf" :
        mode: "000755"
        owner: root
        group: root
        content: |
            upstream my_app {
              server unix:///var/run/puma/my_app.sock;
            }

            log_format healthd '$msec"$uri"'
                            '$status"$request_time"$upstream_response_time"'
                            '$http_x_forwarded_for';
            server {
              listen 80;
              passenger_enabled on;
              passenger_app_env production;
              passenger_ruby /opt/rubies/ruby-2.3.1/bin/ruby;
              keepalive_timeout 10;
              server_name _ localhost kriya.ai; # need to listen to localhost for worker tier
              root /var/app/current/public;
              client_max_body_size 4G;


              if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
                set $year $1;
                set $month $2;
                set $day $3;
                set $hour $4;
              }
              # set $fixedWWW '';
              # set $needRedir 0;
              # nginx does not allow nested if statements
              # check and decide on adding www prefix
              #if ($host !~* ^www(.*)) {
              #	set $fixedWWW 'www.';
              #	set $needRedir 1;
              #}
              # what about that https? the traffic is all http right now
              # but elastic load balancer tells us about the original scheme
              # using $http_x_forwarded_proto variable
              #if ($http_x_forwarded_proto != 'https') {
              #	set $needRedir 1;
              #}

              # ok, so whats the verdict, do we need to redirect?
              #if ($needRedir = 1) {
              #	rewrite ^(.*) https://$fixedWWW$host$1 redirect;
              #}

              access_log  /var/log/nginx/access.log  main;
              access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;

              try_files $uri/index.html $uri @my_app;
              large_client_header_buffers 8 32k;
              location @my_app {
                proxy_pass http://my_app; # match the name of upstream directive which is defined above
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              }

              location /assets {
                alias /var/app/current/public/assets;
                gzip_static on;
                gzip on;
                expires max;
                add_header Cache-Control public;
              }


              location /cable {
                passenger_app_group_name websocket;
                passenger_force_max_concurrent_requests_per_process 0;
              }
            }
    "/opt/elasticbeanstalk/hooks/appdeploy/post/03_restart_nginx.sh":
        mode: "000755"
        owner: root
        group: root
        content: |
            #!/usr/bin/env bash
            rm /etc/nginx/conf.d/webapp_healthd.conf.bak

            if [ -f /etc/nginx/conf.d/custom.conf ]
            then
              rm /etc/nginx/conf.d/custom.conf
            fi

            service nginx restart
